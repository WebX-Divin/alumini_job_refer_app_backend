name: Alumini Job Refer App - AI Assisted

on:
  push:
    branches:
      - main

jobs:

  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: "3.8"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Set up Ngrok and authenticate
      run: |
        wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3.2.0-linux-amd64.zip
        unzip ngrok-v3.2.0-linux-amd64.zip
        ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

    - name: Setup and run Ngrok tunnel
      run: |
        nohup ./ngrok http --domain=smart-insect-cleanly.ngrok-free.app 8000 
    - name: Run Uvicorn app
      run: |
        source venv/bin/activate
        nohup uvicorn routes:app --host 0.0.0.0 --port 8000 & 
        
    - name: Get Ngrok URL
      run: |
        ngrok_url=$(curl -s localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
        echo "Uvicorn app is running at $ngrok_url"
